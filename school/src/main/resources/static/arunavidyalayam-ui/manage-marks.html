<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Manage Marks - Teacher</title>
    <style>
        body{font-family:Poppins, sans-serif;background:#f6f9ff;margin:0;color:#122}
        header{background:linear-gradient(90deg,#007bff,#00bfff);color:#fff;padding:12px 18px;display:flex;align-items:center;justify-content:space-between}
        header h1{font-size:1rem;margin:0}
        .container{max-width:1100px;margin:22px auto;padding:18px;background:#fff;border-radius:10px;box-shadow:0 6px 24px rgba(1,30,70,0.06)}
        .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
        label{font-size:0.9rem;color:#334}
        select,input,textarea{padding:8px;border-radius:6px;border:1px solid #d0d8e6}
        button{background:#007bff;color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
        button.secondary{background:#6c757d}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{padding:8px;border:1px solid #e6eefc;text-align:left}
        th{background:#f0f7ff}
        .muted{color:#666}
        .small{font-size:0.9rem;color:#556}
        .loading{opacity:0.6;pointer-events:none}
    </style>
</head>
<body>
<header>
    <h1>Manage Marks</h1>
    <div>
        <button id="backBtn" class="secondary">‚Üê Back</button>
    </div>
</header>

<div class="container">
    <div class="row">
        <div>
            <label class="small">Select Class</label><br/>
            <select id="classSelect"><option>Loading...</option></select>
        </div>

        <div>
            <label class="small">Select Student</label><br/>
            <select id="studentSelect"><option value="">-- choose class first --</option></select>
        </div>

        <div style="flex:1">
            <label class="small">Subject</label><br/>
            <select id="subject" style="width:100%">
                <option value="">-- Select subject --</option>
                <option>Telugu</option>
                <option>Hindi</option>
                <option>English</option>
                <option>Maths</option>
                <option>Physics</option>
                <option>Science</option>
                <option>Social</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div>
            <label class="small">Exam Type</label><br/>
            <select id="examType">
                <option value="">-- Select exam type --</option>
                <option>Unit1</option>
                <option>Unit2</option>
                <option>Unit3</option>
                <option>Quarterly</option>
                <option>Halfyearly</option>
                <option>Final</option>
            </select>
        </div>
        <div>
            <label class="small">Marks Obtained</label><br/>
            <input id="marksObtained" type="number" min="0" />
        </div>
        <div>
            <label class="small">Max Marks</label><br/>
            <input id="maxMarks" type="number" min="1" />
        </div>
        <div>
            <label class="small">Exam Date</label><br/>
            <input id="examDate" type="date" />
        </div>

        <div>
            <label class="small">&nbsp;</label><br/>
            <button id="saveMarkBtn">Save Mark</button>
        </div>
    </div>

    <div id="feedback" class="muted"></div>

    <hr/>

    <div class="row" style="justify-content:space-between;align-items:center">
        <div><strong>Marks for Class</strong></div>
        <div>
            <button id="loadClassMarksBtn">Load Class Marks</button>
            <button id="loadStudentMarksBtn" class="secondary">Load Selected Student Marks</button>
        </div>
    </div>

    <table id="marksTable">
        <thead>
        <tr><th>ID</th><th>Student</th><th>Subject</th><th>Exam</th><th>Marks</th><th>Max</th><th>Date</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const API_BASE = "http://localhost:8080";
    const CLASS_API = API_BASE + "/api/classrooms";
    const STUDENTS_BY_CLASS = id => `${CLASS_API}/${id}/students`;
    const MARKS_API = API_BASE + "/api/marks";
    const MARKS_BY_CLASS = id => `${MARKS_API}/class/${id}`;
    const MARKS_BY_STUDENT = id => `${MARKS_API}/student/${id}`;

    const classSelect = document.getElementById('classSelect');
    const studentSelect = document.getElementById('studentSelect');
    const subjectInput = document.getElementById('subject');
    const examTypeInput = document.getElementById('examType');
    const marksObtainedInput = document.getElementById('marksObtained');
    const maxMarksInput = document.getElementById('maxMarks');
    const examDateInput = document.getElementById('examDate');
    const saveMarkBtn = document.getElementById('saveMarkBtn');
    const feedback = document.getElementById('feedback');
    const loadClassMarksBtn = document.getElementById('loadClassMarksBtn');
    const loadStudentMarksBtn = document.getElementById('loadStudentMarksBtn');
    const marksTableBody = document.querySelector('#marksTable tbody');
    const backBtn = document.getElementById('backBtn');

    // initialize
    examDateInput.value = new Date().toISOString().slice(0,10);

    async function loadClasses(){
      try {
        const r = await fetch(CLASS_API);
        if(!r.ok) throw new Error('Failed to load classes');
        const classes = await r.json();
        classSelect.innerHTML = `<option value="">-- Select class --</option>`;
        classes.forEach(c => {
          const label = c.name + (c.section ? ' - '+c.section : '');
          classSelect.innerHTML += `<option value="${c.id}">${label}</option>`;
        });
      } catch (e){
        console.error(e);
        classSelect.innerHTML = `<option value="">Failed to load</option>`;
      }
    }

    classSelect.addEventListener('change', async ()=> {
      const classId = classSelect.value;
      studentSelect.innerHTML = `<option value="">Loading students...</option>`;
      marksTableBody.innerHTML = '';
      feedback.textContent = '';
      if(!classId) {
        studentSelect.innerHTML = `<option value="">-- choose class first --</option>`;
        return;
      }
      try {
        const r = await fetch(STUDENTS_BY_CLASS(classId));
        if(!r.ok) throw new Error('Failed to load students');
        const students = await r.json();
        studentSelect.innerHTML = `<option value="">-- Select student (optional) --</option>`;
        students.forEach(s => {
          studentSelect.innerHTML += `<option value="${s.id}">${s.name} (${s.rollNumber||''})</option>`;
        });
      } catch (e) {
        console.error(e);
        studentSelect.innerHTML = `<option value="">Failed to load</option>`;
      }
    });

    saveMarkBtn.addEventListener('click', async () => {
      const classId = classSelect.value;
      const studentId = studentSelect.value;
      const subject = (subjectInput.value || '').trim();
      const examType = (examTypeInput.value || '').trim();
      const marksObtained = marksObtainedInput.value ? parseInt(marksObtainedInput.value,10) : null;
      const maxMarks = maxMarksInput.value ? parseInt(maxMarksInput.value,10) : null;
      const examDate = examDateInput.value;

      if(!classId || !studentId) { feedback.textContent = 'Select class and student'; feedback.style.color='red'; return; }
      if(!subject || !examType || marksObtained == null || maxMarks == null) {
        feedback.textContent = 'Enter subject, exam type, marks and max marks'; feedback.style.color='red'; return;
      }

      const payload = {
        subject,
        examType,
        marksObtained,
        maxMarks,
        examDate,
        student: { id: parseInt(studentId) },
        classroom: { id: parseInt(classId) }
      };

      try {
        const r = await fetch(MARKS_API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!r.ok) {
          // try to read JSON error or text
          let body = await (async ()=>{ try { return await r.json(); } catch(e){ return await r.text().catch(()=>null); } })();
          console.error('Save failed', r.status, body);
          feedback.textContent = 'Save failed: ' + (body && (body.message||body) || r.statusText);
          feedback.style.color='red';
          return;
        }
        const saved = await r.json();
        feedback.textContent = 'Saved mark successfully';
        feedback.style.color='green';
        // clear inputs (optional)
        subjectInput.value = '';
        examTypeInput.value = '';
        marksObtainedInput.value = '';
        maxMarksInput.value = '';
        // reload class marks
        loadClassMarks();
      } catch (e) {
        console.error(e);
        feedback.textContent = 'Network error while saving';
        feedback.style.color='red';
      }
    });


async function loadClassMarks(){
  const classId = classSelect.value;
  if(!classId) { feedback.textContent = 'Please select a class first'; feedback.style.color='red'; return; }

  const examTypeValue = (examTypeInput.value || '').trim();
  const studentIdValue = (studentSelect.value || '').trim(); // optional

  // disable while loading
  loadClassMarksBtn.classList.add('loading');
  loadClassMarksBtn.textContent = 'Loading...';
  feedback.textContent = '';

  try {
    // build URL with optional params
    let url = `${MARKS_BY_CLASS(classId)}`; // e.g. /api/marks/class/{id}
    const params = new URLSearchParams();
    if (examTypeValue) params.set('examType', examTypeValue);
    if (studentIdValue) params.set('studentId', studentIdValue);
    const qs = params.toString();
    if (qs) url += '?' + qs;

    const r = await fetch(url);
    if(!r.ok) {
      let body = await (async ()=>{ try { return await r.json(); } catch(e){ return await r.text().catch(()=>null); } })();
      console.error('Load class marks failed', r.status, body);
      feedback.textContent = 'Failed to load class marks: ' + (body && (body.message||body) || r.statusText);
      feedback.style.color='red';
      marksTableBody.innerHTML = '';
      return;
    }
    const list = await r.json();
    renderMarks(list);
    feedback.textContent = '';
  } catch (e) {
    console.error('Load class marks network error', e);
    feedback.textContent = 'Network error while loading marks';
    feedback.style.color='red';
  } finally {
    loadClassMarksBtn.classList.remove('loading');
    loadClassMarksBtn.textContent = 'Load Class Marks';
  }
}



<!--    async function loadStudentMarks(){-->
<!--      const studentId = studentSelect.value;-->
<!--      if(!studentId) { feedback.textContent = 'Select a student'; feedback.style.color='red'; return; }-->
<!--      feedback.textContent = '';-->
<!--      try {-->
<!--        const r = await fetch(MARKS_BY_STUDENT(studentId));-->
<!--        if(!r.ok) {-->
<!--          let body = await (async ()=>{ try { return await r.json(); } catch(e){ return await r.text().catch(()=>null); } })();-->
<!--          feedback.textContent = 'Failed to load student marks: ' + (body && (body.message||body) || r.statusText);-->
<!--          feedback.style.color='red';-->
<!--          marksTableBody.innerHTML = '';-->
<!--          return;-->
<!--        }-->
<!--        const list = await r.json();-->
<!--        renderMarks(list);-->
<!--      } catch (e) {-->
<!--        console.error(e);-->
<!--        feedback.textContent = 'Failed to load student marks';-->
<!--        feedback.style.color='red';-->
<!--      }-->
<!--    }-->


async function loadStudentMarks() {
  const studentId = studentSelect.value;
  if (!studentId) {
    feedback.textContent = 'Select a student';
    feedback.style.color = 'red';
    return;
  }

  // optional filters from UI (subject and examType dropdowns already exist)
  const examTypeValue = (examTypeInput && examTypeInput.value || '').trim();
  const subjectValue = (subjectInput && subjectInput.value || '').trim();

  feedback.textContent = '';
  marksTableBody.innerHTML = ''; // clear old rows while loading

  try {
    // Build URL: /api/marks/student/{id}?examType=...&subject=...
    let url = MARKS_BY_STUDENT(studentId);
    const params = new URLSearchParams();
    if (examTypeValue) params.set('examType', examTypeValue);
    if (subjectValue) params.set('subject', subjectValue);
    const qs = params.toString();
    if (qs) url += '?' + qs;

    const r = await fetch(url);
    if (!r.ok) {
      // try to read JSON error or plain text
      let body = null;
      try { body = await r.json(); } catch (e) { try { body = await r.text(); } catch(e2){ body = null; } }
      console.error('Load student marks failed', r.status, body);
      feedback.textContent = 'Failed to load student marks: ' + (body && (body.message || body) || r.statusText);
      feedback.style.color = 'red';
      marksTableBody.innerHTML = '';
      return;
    }

    const list = await r.json();
    renderMarks(list);
    feedback.textContent = '';
    feedback.style.color = 'green';
  } catch (e) {
    console.error('Load student marks error', e);
    feedback.textContent = 'Failed to load student marks';
    feedback.style.color = 'red';
    marksTableBody.innerHTML = '';
  }
}


// NOTE: Keeps 7 columns to match your table header: ID | Student | Subject | Exam | Marks | Max | Date
function renderMarks(list) {
  marksTableBody.innerHTML = '';
  if (!list || list.length === 0) {
    marksTableBody.innerHTML = `<tr><td colspan="7" class="muted">No marks found</td></tr>`;
    return;
  }

  list.forEach(m => {
    const tr = document.createElement('tr');

    // student name fallback: nested student object or flattened fields
    const sObj = m.student || {};
    const studentName = sObj.name ?? m.studentName ?? '';
    // subject / exam fields
    const subjectVal = m.subject ?? '';
    const examTypeVal = m.examType ?? '';
    // marks values
    const marksObt = (m.marksObtained !== undefined && m.marksObtained !== null) ? m.marksObtained : '';
    const maxMarksVal = (m.maxMarks !== undefined && m.maxMarks !== null) ? m.maxMarks : '';
    // date field: support common keys
    const date = m.examDate ?? m.examDateString ?? m.date ?? '';

    tr.innerHTML = `<td>${m.id ?? ''}</td>
                    <td>${escapeHtml(studentName)}</td>
                    <td>${escapeHtml(subjectVal)}</td>
                    <td>${escapeHtml(examTypeVal)}</td>
                    <td style="text-align:right">${marksObt}</td>
                    <td style="text-align:right">${maxMarksVal}</td>
                    <td>${date}</td>`;

    marksTableBody.appendChild(tr);
  });
}


<!--    function renderMarks(list){-->
<!--      marksTableBody.innerHTML = '';-->
<!--      if(!list || list.length === 0) {-->
<!--        marksTableBody.innerHTML = `<tr><td colspan="7" class="muted">No marks found</td></tr>`;-->
<!--        return;-->
<!--      }-->
<!--      list.forEach(m => {-->
<!--        const tr = document.createElement('tr');-->
<!--        const sName = m.student ? (m.student.name || '') : '';-->
<!--        const date = m.examDate || m.examDateString || '';-->
<!--        tr.innerHTML = `<td>${m.id||''}</td>-->
<!--                        <td>${escapeHtml(sName)}</td>-->
<!--                        <td>${escapeHtml(m.subject||'')}</td>-->
<!--                        <td>${escapeHtml(m.examType||'')}</td>-->
<!--                        <td>${m.marksObtained ?? ''}</td>-->
<!--                        <td>${m.maxMarks ?? ''}</td>-->
<!--                        <td>${date}</td>`;-->
<!--        marksTableBody.appendChild(tr);-->
<!--      });-->
<!--    }-->








    function escapeHtml(s) {
      if (!s) return '';
      return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    // hooks
    loadClassMarksBtn.addEventListener('click', loadClassMarks);
    loadStudentMarksBtn.addEventListener('click', loadStudentMarks);
    backBtn.addEventListener('click', ()=> window.location.href='teacher-landing.html');

    // init
    loadClasses();
</script>
</body>
</html>
